x-common-vars: &common-vars
  GLA1V3_DOMAIN: gla1v3.local

services:
  traefik:
    image: traefik:v2.10  # ← KEPT: Your preferred stable version
    container_name: traefik
    restart: unless-stopped
    ports:
      - "443:443"
      - "4443:4443"  # ← KEPT: Exposed for agent beacons
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/data
      - traefik-logs:/logs
      - traefik-certs:/etc/traefik/certs:ro  # ← KEPT: Binds your certs folder
      - ./traefik.yml:/etc/traefik/traefik.yml:ro  # ← UNCOMMENTED: Static config
      - ./dynamic.yml:/etc/traefik/dynamic.yml:ro  # ← UNCOMMENTED: Dynamic mTLS + certs
    environment:
      - GLA1V3_DOMAIN=gla1v3.local  # ← FIXED: Full value (was just "GLA1V3_DOMAIN")
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file=true  # ← ADDED: Enable file provider for dynamic.yml
      - --entrypoints.websecure.address=:443
      - --entrypoints.c2.address=:4443  # mTLS for agents
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls=true"  # Uses default store from dynamic.yml
    networks:
      - gla1v3-net

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: gla1v3
      POSTGRES_USER: gla1v3
      POSTGRES_PASSWORD: gla1v3password
      GLA1V3_DOMAIN: gla1v3.local
    volumes:
      - postgres-data:/var/lib/postgresql/data
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  # NOTE: Temporary cert-init one-shot removed. Previously this copied
  # host-generated certs into the manager volume. That behaviour caused
  # confusion and leftover files; cert provisioning should be handled
  # by a dedicated session cert generator (TODO).

  wazuh-manager:
    image: wazuh/wazuh-manager:4.8.2
    container_name: wazuh-manager
    restart: unless-stopped
    depends_on:
      - certs-init
      - wazuh-indexer
    environment:
      - INDEXER_URL=https://demo.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=admin_password
      - FILEBEAT_SSL_VERIFICATION=false
      - WAZUH_API_HTTPS=true
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/certs/ca.crt
      - FILEBEAT_SSL_VERIFICATION_MODE=full
    volumes:
      - wazuh-etc:/var/ossec
      - wazuh-data:/var/ossec/data
      - ../certs:/etc/ssl/certs:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wazuh.rule=Host(`wazuh.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.wazuh.tls=true"
      - "traefik.http.services.wazuh.loadbalancer.server.port=55000"
    networks:
      gla1v3-net:
        aliases:
          - wazuh.com

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.8.2
    container_name: wazuh-indexer
    restart: unless-stopped
    depends_on:
      - certs-init
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - DISABLE_SECURITY_PLUGIN=true
    volumes:
      - wazuh-indexer-data:/var/lib/opensearch
      - ../certs:/etc/ssl/certs:ro
    labels:
      - "traefik.enable=false"
    networks:
      gla1v3-net:
        aliases:
          - demo.indexer

  certs-init:
    image: ubuntu:22.04
    container_name: infra-certs-init
    restart: 'no'
    volumes:
      - ../certs:/certs
      - ./generate_session_certs.sh:/scripts/generate_session_certs.sh:ro
    command: sh -c "apt-get update >/dev/null && apt-get install -y --no-install-recommends openssl bash >/dev/null && /bin/bash /scripts/generate_session_certs.sh"
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  backend:
    build: ../backend
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://gla1v3:gla1v3password@postgres:5432/gla1v3
      - GLA1V3_DOMAIN=gla1v3.local  # ← ADDED: Full value for labels
      # Secure token for agent whoami endpoint. Change as needed; kept here for POC.
      - AGENT_WHOAMI_TOKEN=3f7b9a2d8c1e4f6a9b0c2d3e4f5a6b7c
      - WAZUH_URL=https://wazuh.com:55000
      - WAZUH_EXPECTED_HOSTNAME=wazuh.com
      - WAZUH_USER=wazuh
      - WAZUH_PASS=changeme
    volumes:
      - ../certs:/app/certs:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.services.api.loadbalancer.server.port=3000"

      # Public health endpoint on :443 (no mTLS)
      - "traefik.http.routers.health.rule=Host(`c2.${GLA1V3_DOMAIN}`) && Path(`/health`)"
      - "traefik.http.routers.health.entrypoints=websecure"
      - "traefik.http.routers.health.tls=true"
      - "traefik.http.routers.health.service=api"

    depends_on:
      - postgres
      - redis
    networks:
      - gla1v3-net

  frontend:
    build: ../frontend
    container_name: frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.${GLA1V3_DOMAIN}`) || Host(`${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5173"
    networks:
      - gla1v3-net

networks:
  gla1v3-net:
    driver: bridge

volumes:
  traefik-data:
  traefik-logs:
  postgres-data:
  redis-data:
  wazuh-etc:
  wazuh-data:
  wazuh-indexer-data:
  traefik-certs:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/../certs
      o: bind