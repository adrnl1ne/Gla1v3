services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    ports:
      - "0.0.0.0:443:443"
      - "0.0.0.0:4443:4443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../certs:/etc/traefik/certs:ro
      - ca-certs:/ca-certs:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic.yml:/etc/traefik/dynamic.yml:ro
    environment:
      - GLA1V3_DOMAIN=gla1v3.local
    networks:
      - gla1v3-net
    depends_on:
      - ca-service

  backend:
    build: ../backend
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - GLA1V3_DOMAIN=gla1v3.local
      - AGENT_WHOAMI_TOKEN=3f7b9a2d8c1e4f6a9b0c2d3e4f5a6b7c
      # TODO: Change to https://host.docker.internal:55000 for better security (defense in depth)
      # Also verify backend uses EDR proxy for queries instead of direct connection
      - WAZUH_URL=http://host.docker.internal:55000
      - WAZUH_USER=wazuh-wui
      - WAZUH_PASS=wazuh-wui
      - JWT_SECRET=CHANGEME_SECURE_SECRET_KEY_HERE
      - ADMIN_PASSWORD=admin
      - INTERNAL_TOKEN=CHANGEME_INTERNAL_TOKEN
    volumes:
      - ../certs:/app/certs:ro
      - ../agents-go:/agents-go:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - ca-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-api.rule=Host(`api.gla1v3.local`)"
      - "traefik.http.routers.backend-api.entrypoints=websecure"
      - "traefik.http.routers.backend-api.tls=true"
      - "traefik.http.routers.backend-api.service=backend-api-svc"
      - "traefik.http.services.backend-api-svc.loadbalancer.server.port=3000"
      - "traefik.http.routers.c2-beacon.rule=Host(`c2.gla1v3.local`) && PathPrefix(`/beacon`)"
      - "traefik.http.routers.c2-beacon.entrypoints=c2"
      - "traefik.http.routers.c2-beacon.tls=true"
      - "traefik.http.routers.c2-beacon.tls.options=mtls@file"
      - "traefik.http.routers.c2-beacon.middlewares=pass-client-cert@file"
      - "traefik.http.routers.c2-beacon.service=c2-svc"
      - "traefik.http.services.c2-svc.loadbalancer.server.port=3001"
      - "traefik.http.routers.c2-health.rule=Host(`c2.gla1v3.local`) && Path(`/health`)"
      - "traefik.http.routers.c2-health.entrypoints=websecure"
      - "traefik.http.routers.c2-health.tls=true"
      - "traefik.http.routers.c2-health.service=backend-api-svc"
    networks:
      - gla1v3-net

  frontend:
    build: ../frontend
    container_name: frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.gla1v3.local`) || Host(`gla1v3.local`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5173"
    networks:
      - gla1v3-net

  ca-service:
    build: ../ca-service
    container_name: ca-service
    restart: unless-stopped
    environment:
      - CERT_DIR=/certs
    volumes:
      - ca-certs:/certs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ca-service.rule=Host(`ca.gla1v3.local`)"
      - "traefik.http.routers.ca-service.entrypoints=websecure"
      - "traefik.http.routers.ca-service.tls=true"
      - "traefik.http.services.ca-service.loadbalancer.server.port=3003"
    networks:
      - gla1v3-net

volumes:
  ca-certs:
    driver: local

networks:
  gla1v3-net:
    driver: bridge