services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    ports:
      - "443:443"
      - "4443:4443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../certs:/etc/traefik/certs:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic.yml:/etc/traefik/dynamic.yml:ro
    environment:
      - GLA1V3_DOMAIN=gla1v3.local
    networks:
      - gla1v3-net

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: gla1v3
      POSTGRES_USER: gla1v3
      POSTGRES_PASSWORD: gla1v3password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - gla1v3-net

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - gla1v3-net

  wazuh:
    image: wazuh/wazuh-manager:4.8.2
    container_name: wazuh
    restart: unless-stopped
    hostname: wazuh
    ports:
      - "1514:1514"
      - "1515:1515"
    environment:
      - FILEBEAT_SSL_VERIFICATION_MODE=none
    volumes:
      - wazuh-data:/var/ossec
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wazuh.rule=Host(`wazuh.gla1v3.local`)"
      - "traefik.http.routers.wazuh.entrypoints=websecure"
      - "traefik.http.routers.wazuh.tls=true"
      - "traefik.http.services.wazuh.loadbalancer.server.port=55000"
    networks:
      - gla1v3-net

  backend:
    build: ../backend
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://gla1v3:gla1v3password@postgres:5432/gla1v3
      - GLA1V3_DOMAIN=gla1v3.local
      - AGENT_WHOAMI_TOKEN=3f7b9a2d8c1e4f6a9b0c2d3e4f5a6b7c
      - WAZUH_URL=https://wazuh:55000
      - WAZUH_USER=wazuh-wui
      - WAZUH_PASS=wazuh-wui
    volumes:
      - ../certs:/app/certs:ro
    depends_on:
      - postgres
      - redis
      - wazuh
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-api.rule=Host(`api.gla1v3.local`)"
      - "traefik.http.routers.backend-api.entrypoints=websecure"
      - "traefik.http.routers.backend-api.tls=true"
      - "traefik.http.routers.backend-api.service=backend-api-svc"
      - "traefik.http.services.backend-api-svc.loadbalancer.server.port=3000"
      - "traefik.http.routers.c2-beacon.rule=Host(`c2.gla1v3.local`) && PathPrefix(`/beacon`)"
      - "traefik.http.routers.c2-beacon.entrypoints=c2"
      - "traefik.http.routers.c2-beacon.tls=true"
      - "traefik.http.routers.c2-beacon.tls.options=mtls@file"
      - "traefik.http.routers.c2-beacon.middlewares=pass-client-cert@file"
      - "traefik.http.routers.c2-beacon.service=c2-svc"
      - "traefik.http.services.c2-svc.loadbalancer.server.port=3001"
      - "traefik.http.routers.c2-health.rule=Host(`c2.gla1v3.local`) && Path(`/health`)"
      - "traefik.http.routers.c2-health.entrypoints=websecure"
      - "traefik.http.routers.c2-health.tls=true"
      - "traefik.http.routers.c2-health.service=backend-api-svc"
    networks:
      - gla1v3-net

  frontend:
    build: ../frontend
    container_name: frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.gla1v3.local`) || Host(`gla1v3.local`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5173"
    networks:
      - gla1v3-net

networks:
  gla1v3-net:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  wazuh-data: