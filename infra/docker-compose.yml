x-common-vars: &common-vars
  GLA1V3_DOMAIN: gla1v3.local

services:
  traefik:
    image: traefik:v2.10  # ← KEPT: Your preferred stable version
    container_name: traefik
    restart: unless-stopped
    ports:
      - "443:443"
      - "4443:4443"  # ← KEPT: Exposed for agent beacons
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-data:/data
      - traefik-logs:/logs
      - traefik-certs:/etc/traefik/certs:ro  # ← KEPT: Binds your certs folder
      - ./traefik.yml:/etc/traefik/traefik.yml:ro  # ← UNCOMMENTED: Static config
      - ./dynamic.yml:/etc/traefik/dynamic.yml:ro  # ← UNCOMMENTED: Dynamic mTLS + certs
    environment:
      - GLA1V3_DOMAIN=gla1v3.local  # ← FIXED: Full value (was just "GLA1V3_DOMAIN")
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file=true  # ← ADDED: Enable file provider for dynamic.yml
      - --entrypoints.websecure.address=:443
      - --entrypoints.c2.address=:4443  # mTLS for agents
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls=true"  # Uses default store from dynamic.yml
    networks:
      - gla1v3-net

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: gla1v3
      POSTGRES_USER: gla1v3
      POSTGRES_PASSWORD: gla1v3password
      GLA1V3_DOMAIN: gla1v3.local
    volumes:
      - postgres-data:/var/lib/postgresql/data
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  wazuh-manager:
    image: wazuh/wazuh-manager:4.8.2
    container_name: wazuh-manager
    restart: unless-stopped
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=admin_password
      - FILEBEAT_SSL_VERIFICATION=false
      - WAZUH_API_HTTPS=true
    depends_on:
      - wazuh-indexer
    volumes:
      - wazuh-etc:/var/ossec/etc
      - wazuh-data:/var/ossec/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wazuh.rule=Host(`wazuh.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.wazuh.tls=true"  # Uses default store
      - "traefik.http.services.wazuh.loadbalancer.server.port=5601"
    networks:
      - gla1v3-net

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.8.2
    container_name: wazuh-indexer
    restart: unless-stopped
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
    volumes:
      - wazuh-indexer-data:/var/lib/opensearch
    labels:
      - "traefik.enable=false"
    networks:
      - gla1v3-net

  backend:
    build: ../backend
    container_name: backend
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://gla1v3:gla1v3password@postgres:5432/gla1v3
      - GLA1V3_DOMAIN=gla1v3.local  # ← ADDED: Full value for labels
    volumes:
      - ../backend:/app
      - /app/node_modules
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.services.api.loadbalancer.server.port=3000"

      # ──────────────────────────────
      # C2 mTLS ENDPOINT – FIXED SYNTAX FOR v2.10
      # ──────────────────────────────
      - "traefik.http.routers.c2.rule=Host(`c2.${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.c2.entrypoints=c2"
      - "traefik.http.routers.c2.tls=true"
      #- "traefik.http.routers.c2.tls.options=default"
      - "traefik.http.routers.c2.tls.options=mtls-required@file"
      - "traefik.http.routers.c2.service=c2"
      - "traefik.http.services.c2.loadbalancer.server.port=3001"  # Forwards to backend /beacon
      - "traefik.http.routers.c2.middlewares=forward-client-cert@file"

    depends_on:
      - postgres
      - redis
    networks:
      - gla1v3-net

  frontend:
    build: ../frontend
    container_name: frontend
    restart: unless-stopped
    volumes:
      - ../frontend:/app
      - /app/node_modules
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.${GLA1V3_DOMAIN}`) || Host(`${GLA1V3_DOMAIN}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5173"
    networks:
      - gla1v3-net

networks:
  gla1v3-net:
    driver: bridge

volumes:
  traefik-data:
  traefik-logs:
  postgres-data:
  redis-data:
  wazuh-etc:
  wazuh-data:
  wazuh-indexer-data:
  traefik-certs:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/../certs
      o: bind